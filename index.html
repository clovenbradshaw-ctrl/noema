<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EO Lake - Data Workbench</title>

  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- Cytoscape.js Graph Visualization -->
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
  <!-- Cytoscape Layout Extensions -->
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

  <link rel="stylesheet" href="eo_styles.css">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="app-sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-icon">
            <i class="ph ph-database"></i>
          </div>
          <span class="logo-text">EO Lake</span>
        </div>
        <button class="sidebar-collapse-btn" id="sidebar-collapse">
          <i class="ph ph-caret-left"></i>
        </button>
      </div>

      <!-- Universal Search with Prefix Support -->
      <div class="sidebar-search">
        <div class="search-input-wrapper">
          <i class="ph ph-magnifying-glass"></i>
          <input type="text" placeholder="Search... (@ # > / ? !)" id="global-search" autocomplete="off">
          <span class="search-prefix-hint" id="search-prefix-hint"></span>
        </div>
        <div class="search-prefix-legend" id="search-prefix-legend">
          <span class="prefix-item" data-prefix="">records</span>
          <span class="prefix-item" data-prefix="@">@fields</span>
          <span class="prefix-item" data-prefix="#">#sets</span>
          <span class="prefix-item" data-prefix="/">/views</span>
          <span class="prefix-item" data-prefix="?">?sources</span>
          <span class="prefix-item" data-prefix=">">&gt;commands</span>
        </div>
      </div>

      <!-- Three-Panel Navigation: Sources (GIVEN) / Sets (Schema) / Views (MEANT) -->
      <nav class="sidebar-nav" id="sidebar-nav">
        <!-- Panel 1: SOURCES (Given - Physical Origins) -->
        <div class="nav-panel sources-panel" data-panel="sources">
          <div class="nav-panel-header">
            <div class="nav-panel-title">
              <i class="ph ph-download-simple"></i>
              <span>Sources</span>
              <span class="nav-panel-badge given-badge">GIVEN</span>
            </div>
            <button class="nav-panel-action" id="btn-import-data" title="Import data (CSV, JSON, ICS)">
              <i class="ph ph-plus"></i>
            </button>
          </div>
          <div class="nav-panel-content" id="sources-nav">
            <!-- Sources tree rendered dynamically -->
          </div>
        </div>

        <!-- Panel 2: SETS (Schema - Entity Types) -->
        <div class="nav-panel sets-panel" data-panel="sets">
          <div class="nav-panel-header">
            <div class="nav-panel-title">
              <i class="ph ph-database"></i>
              <span>Sets</span>
              <span class="nav-panel-badge schema-badge">SCHEMA</span>
            </div>
            <button class="nav-panel-action" id="btn-new-set" title="Create new set">
              <i class="ph ph-plus"></i>
            </button>
          </div>
          <div class="nav-panel-content" id="sets-nav">
            <!-- Sets rendered dynamically (flat list) -->
          </div>
        </div>

        <!-- Panel 3: VIEWS (Meant - Interpretations) -->
        <div class="nav-panel views-panel" data-panel="views">
          <div class="nav-panel-header">
            <div class="nav-panel-title">
              <i class="ph ph-eye"></i>
              <span>Views</span>
              <span class="nav-panel-badge meant-badge">MEANT</span>
            </div>
            <button class="nav-panel-action" id="btn-new-workspace" title="Create new workspace">
              <i class="ph ph-plus"></i>
            </button>
          </div>
          <div class="nav-panel-content" id="views-nav">
            <!-- Workspaces > Lenses > Focuses rendered dynamically -->
          </div>
        </div>
      </nav>

      <!-- Sidebar Footer -->
      <div class="sidebar-footer">
        <div class="nav-item" id="nav-keyboard-shortcuts" title="Keyboard Shortcuts (?)">
          <i class="ph ph-keyboard"></i>
          <span>Shortcuts</span>
        </div>
        <div class="nav-item" id="nav-settings">
          <i class="ph ph-gear"></i>
          <span>Settings</span>
        </div>
        <div class="nav-item" id="nav-sync">
          <i class="ph ph-cloud-check"></i>
          <span>Sync Status</span>
          <span class="sync-badge synced" id="sync-status-badge">
            <i class="ph ph-check-circle"></i>
          </span>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Toolbar -->
      <header class="header">
        <div class="header-left">
          <button class="header-btn mobile-menu" id="mobile-menu-btn">
            <i class="ph ph-list"></i>
          </button>
          <div class="breadcrumb">
            <span class="breadcrumb-item" id="current-workspace-name" title="Workspace (Rule 4)">
              <i class="ph ph-folder-simple"></i>
              Workspace
            </span>
            <i class="ph ph-caret-right"></i>
            <span class="breadcrumb-item" id="current-set-name">All Records</span>
            <i class="ph ph-caret-right"></i>
            <span class="breadcrumb-item" id="current-view-name">Lens</span>
            <span class="breadcrumb-item active focus-breadcrumb" id="current-focus-name" style="display: none;">
              <i class="ph ph-caret-right"></i>
              <i class="ph ph-funnel"></i>
              Focus
            </span>
          </div>
        </div>
        <div class="header-center">
          <!-- View Switcher -->
          <div class="view-switcher">
            <button class="view-switch-btn active" data-view="table" title="Table View">
              <i class="ph ph-table"></i>
            </button>
            <button class="view-switch-btn" data-view="cards" title="Card View">
              <i class="ph ph-cards"></i>
            </button>
            <button class="view-switch-btn" data-view="kanban" title="Kanban View">
              <i class="ph ph-kanban"></i>
            </button>
            <button class="view-switch-btn" data-view="calendar" title="Calendar View">
              <i class="ph ph-calendar-blank"></i>
            </button>
            <button class="view-switch-btn" data-view="graph" title="Graph View">
              <i class="ph ph-graph"></i>
            </button>
            <button class="view-switch-btn" data-view="filesystem" title="Filesystem View">
              <i class="ph ph-folder-open"></i>
            </button>
          </div>
        </div>
        <div class="header-right">
          <div class="header-actions">
            <button class="header-btn" id="btn-import" title="Import CSV or JSON">
              <i class="ph ph-upload"></i>
              <span class="btn-label">Import</span>
            </button>
            <button class="header-btn" id="btn-filter" title="Create Focus (Rule 5: Restrict only)">
              <i class="ph ph-funnel"></i>
              <span class="btn-label">Focus</span>
            </button>
            <button class="header-btn" id="btn-sort" title="Sort">
              <i class="ph ph-sort-ascending"></i>
              <span class="btn-label">Sort</span>
            </button>
            <button class="header-btn" id="btn-snapshot" title="Create Snapshot (Rule 9: Immutable capture)">
              <i class="ph ph-camera"></i>
              <span class="btn-label">Snapshot</span>
            </button>
            <div class="header-divider"></div>
            <button class="header-btn primary" id="btn-add-record">
              <i class="ph ph-plus"></i>
              <span class="btn-label">Add Record</span>
            </button>
          </div>
        </div>
      </header>

      <!-- Bulk Actions Toolbar (shown when records selected) -->
      <div class="bulk-actions-toolbar" id="bulk-actions-toolbar" style="display: none;">
        <div class="bulk-actions-info">
          <i class="ph ph-check-square"></i>
          <span id="bulk-selected-count">0 selected</span>
        </div>
        <div class="bulk-actions-buttons">
          <button class="bulk-action-btn" id="bulk-duplicate" title="Duplicate selected">
            <i class="ph ph-copy"></i>
            <span>Duplicate</span>
          </button>
          <button class="bulk-action-btn" id="bulk-export" title="Export selected">
            <i class="ph ph-export"></i>
            <span>Export</span>
          </button>
          <button class="bulk-action-btn danger" id="bulk-delete" title="Delete selected">
            <i class="ph ph-trash"></i>
            <span>Delete</span>
          </button>
        </div>
        <button class="bulk-actions-close" id="bulk-actions-close" title="Clear selection">
          <i class="ph ph-x"></i>
        </button>
      </div>

      <!-- Browser-Style Tab Bar -->
      <div class="tab-bar" id="tab-bar">
        <div class="tab-bar-scroll-left" id="tab-scroll-left" style="display: none;">
          <i class="ph ph-caret-left"></i>
        </div>
        <div class="tab-bar-tabs" id="tab-bar-tabs">
          <!-- Tabs rendered dynamically -->
        </div>
        <div class="tab-bar-scroll-right" id="tab-scroll-right" style="display: none;">
          <i class="ph ph-caret-right"></i>
        </div>
        <button class="tab-bar-new-tab" id="new-tab-btn" title="New tab (Ctrl+T)">
          <i class="ph ph-plus"></i>
        </button>
        <div class="tab-bar-actions">
          <button class="tab-bar-action-btn" id="tab-list-btn" title="View all tabs">
            <i class="ph ph-caret-down"></i>
          </button>
        </div>
      </div>

      <!-- Content Area -->
      <div class="content-area" id="content-area">
        <!-- Workbench rendered here -->
      </div>

      <!-- Status Bar -->
      <footer class="status-bar">
        <div class="status-left">
          <span class="status-item" id="record-count">
            <i class="ph ph-rows"></i>
            <span>0 records</span>
          </span>
          <span class="status-divider"></span>
          <span class="status-item" id="selected-count">
            <i class="ph ph-check-square"></i>
            <span>0 selected</span>
          </span>
        </div>
        <div class="status-center">
          <span class="status-item eo-indicator" id="eo-status">
            <span class="eo-dot given"></span>
            <span class="eo-dot meant"></span>
            <span>EO Compliant</span>
          </span>
        </div>
        <div class="status-right">
          <span class="status-item" id="last-saved">
            <i class="ph ph-clock"></i>
            <span>Just now</span>
          </span>
        </div>
      </footer>
    </main>

    <!-- Record Detail Panel (Right Sidebar) -->
    <aside class="detail-panel" id="detail-panel">
      <div class="detail-panel-header">
        <h3>Record Details</h3>
        <button class="detail-panel-close" id="detail-panel-close">
          <i class="ph ph-x"></i>
        </button>
      </div>
      <div class="detail-panel-body" id="detail-panel-body">
        <div class="empty-state-small">
          <i class="ph ph-cursor-click"></i>
          <p>Select a record to view details</p>
        </div>
      </div>
    </aside>
  </div>

  <!-- Modal Overlay -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal" id="modal">
      <div class="modal-header">
        <h3 class="modal-title">Modal Title</h3>
        <button class="modal-close" id="modal-close">
          <i class="ph ph-x"></i>
        </button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Modal content -->
      </div>
      <div class="modal-footer" id="modal-footer">
        <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
        <button class="btn btn-primary" id="modal-confirm">Save</button>
      </div>
    </div>
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="context-menu">
    <!-- Context menu items rendered dynamically -->
  </div>

  <!-- Advanced Filter Panel -->
  <div class="filter-panel" id="filter-panel" style="display: none;">
    <div class="filter-panel-header">
      <h4><i class="ph ph-funnel"></i> Filter Records</h4>
      <button class="filter-panel-close" id="filter-panel-close">
        <i class="ph ph-x"></i>
      </button>
    </div>
    <div class="filter-panel-body">
      <div class="filter-groups" id="filter-groups">
        <!-- Filter rows added dynamically -->
      </div>
      <button class="add-filter-btn" id="add-filter-btn">
        <i class="ph ph-plus"></i>
        <span>Add filter</span>
      </button>
      <div class="filter-logic-toggle">
        <span class="filter-logic-label">Match</span>
        <select class="filter-logic-select" id="filter-logic">
          <option value="and">All filters (AND)</option>
          <option value="or">Any filter (OR)</option>
        </select>
      </div>
    </div>
    <div class="filter-panel-footer">
      <button class="btn btn-secondary" id="filter-clear">Clear All</button>
      <button class="btn btn-primary" id="filter-apply">Apply Filter</button>
    </div>
  </div>

  <!-- Sort Panel -->
  <div class="sort-panel" id="sort-panel" style="display: none;">
    <div class="sort-panel-header">
      <h4><i class="ph ph-sort-ascending"></i> Sort Records</h4>
      <button class="sort-panel-close" id="sort-panel-close">
        <i class="ph ph-x"></i>
      </button>
    </div>
    <div class="sort-panel-body">
      <div class="sort-rules" id="sort-rules">
        <!-- Sort rules added dynamically -->
      </div>
      <button class="add-sort-btn" id="add-sort-btn">
        <i class="ph ph-plus"></i>
        <span>Add sort</span>
      </button>
    </div>
    <div class="sort-panel-footer">
      <button class="btn btn-secondary" id="sort-clear">Clear All</button>
      <button class="btn btn-primary" id="sort-apply">Apply Sort</button>
    </div>
  </div>

  <!-- Field Type Picker -->
  <div class="field-type-picker" id="field-type-picker">
    <div class="field-type-list">
      <div class="field-type-item" data-type="text">
        <i class="ph ph-text-aa"></i>
        <span>Single line text</span>
      </div>
      <div class="field-type-item" data-type="longText">
        <i class="ph ph-text-align-left"></i>
        <span>Long text</span>
      </div>
      <div class="field-type-item" data-type="number">
        <i class="ph ph-hash"></i>
        <span>Number</span>
      </div>
      <div class="field-type-item" data-type="select">
        <i class="ph ph-list-bullets"></i>
        <span>Single select</span>
      </div>
      <div class="field-type-item" data-type="multiSelect">
        <i class="ph ph-list-checks"></i>
        <span>Multiple select</span>
      </div>
      <div class="field-type-item" data-type="date">
        <i class="ph ph-calendar"></i>
        <span>Date</span>
      </div>
      <div class="field-type-item" data-type="checkbox">
        <i class="ph ph-check-square"></i>
        <span>Checkbox</span>
      </div>
      <div class="field-type-item" data-type="link">
        <i class="ph ph-link"></i>
        <span>Link to record</span>
      </div>
      <div class="field-type-item" data-type="attachment">
        <i class="ph ph-paperclip"></i>
        <span>Attachment</span>
      </div>
      <div class="field-type-item" data-type="url">
        <i class="ph ph-globe"></i>
        <span>URL</span>
      </div>
      <div class="field-type-item" data-type="email">
        <i class="ph ph-envelope"></i>
        <span>Email</span>
      </div>
      <div class="field-type-item" data-type="phone">
        <i class="ph ph-phone"></i>
        <span>Phone</span>
      </div>
      <div class="field-type-item" data-type="formula">
        <i class="ph ph-function"></i>
        <span>Formula</span>
      </div>
      <div class="field-type-item" data-type="rollup">
        <i class="ph ph-sigma"></i>
        <span>Rollup</span>
      </div>
      <div class="field-type-item" data-type="count">
        <i class="ph ph-number-circle-one"></i>
        <span>Count</span>
      </div>
      <div class="field-type-item" data-type="autonumber">
        <i class="ph ph-number-square-one"></i>
        <span>Autonumber</span>
      </div>
      <div class="field-type-item" data-type="json">
        <i class="ph ph-brackets-curly"></i>
        <span>JSON</span>
      </div>
    </div>
  </div>

  <!-- Keyboard Shortcuts Modal -->
  <div class="shortcuts-modal-overlay" id="shortcuts-modal" style="display: none;">
    <div class="shortcuts-modal">
      <div class="shortcuts-modal-header">
        <h3><i class="ph ph-keyboard"></i> Keyboard Shortcuts</h3>
        <button class="shortcuts-modal-close" id="shortcuts-modal-close">
          <i class="ph ph-x"></i>
        </button>
      </div>
      <div class="shortcuts-modal-body">
        <div class="shortcuts-section">
          <h4>General</h4>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>?</kbd></span>
            <span class="shortcut-desc">Show keyboard shortcuts</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Esc</kbd></span>
            <span class="shortcut-desc">Close modal/panel, cancel edit</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd>+<kbd>/</kbd></span>
            <span class="shortcut-desc">Focus search</span>
          </div>
        </div>
        <div class="shortcuts-section">
          <h4>Records</h4>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd>+<kbd>N</kbd></span>
            <span class="shortcut-desc">Add new record</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Delete</kbd></span>
            <span class="shortcut-desc">Delete selected records</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd>+<kbd>D</kbd></span>
            <span class="shortcut-desc">Duplicate selected records</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd>+<kbd>A</kbd></span>
            <span class="shortcut-desc">Select all records</span>
          </div>
        </div>
        <div class="shortcuts-section">
          <h4>Editing</h4>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Enter</kbd></span>
            <span class="shortcut-desc">Confirm edit / Open selected record</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Tab</kbd></span>
            <span class="shortcut-desc">Move to next cell</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Shift</kbd>+<kbd>Tab</kbd></span>
            <span class="shortcut-desc">Move to previous cell</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Double-click</kbd></span>
            <span class="shortcut-desc">Edit cell</span>
          </div>
        </div>
        <div class="shortcuts-section">
          <h4>Views</h4>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>1</kbd>-<kbd>5</kbd></span>
            <span class="shortcut-desc">Switch view (Table, Cards, Kanban, Calendar, Graph)</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd>+<kbd>F</kbd></span>
            <span class="shortcut-desc">Open filter/focus panel</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd>+<kbd>S</kbd></span>
            <span class="shortcut-desc">Create snapshot</span>
          </div>
        </div>
        <div class="shortcuts-section">
          <h4>Tabs</h4>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd>+<kbd>T</kbd></span>
            <span class="shortcut-desc">New tab</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd>+<kbd>W</kbd></span>
            <span class="shortcut-desc">Close current tab</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd>+<kbd>Tab</kbd></span>
            <span class="shortcut-desc">Next tab</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>Tab</kbd></span>
            <span class="shortcut-desc">Previous tab</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>T</kbd></span>
            <span class="shortcut-desc">Pick up last tossed tab</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd>+<kbd>1</kbd>-<kbd>9</kbd></span>
            <span class="shortcut-desc">Switch to tab 1-9</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Middle-click</kbd></span>
            <span class="shortcut-desc">Toss tab</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Double-click</kbd></span>
            <span class="shortcut-desc">Rename tab</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Principles Transparency Panel Container -->
  <div id="principles-panel" class="principles-panel"></div>

  <!-- Scripts - Core EO Modules -->
  <script src="eo_operators.js"></script>     <!-- Layer 4: 9 EO Operators -->
  <script src="eo_ontology.js"></script>      <!-- Ontology: Source/Set separation, Derivation, Workflow -->
  <script src="eo_activity.js"></script>      <!-- Activity System: Operator × Target × Context -->
  <script src="eo_event_store.js"></script>
  <script src="eo_horizon.js"></script>
  <script src="eo_compliance.js"></script>
  <script src="eo_state_derivation.js"></script>
  <script src="eo_persistence.js"></script>
  <script src="eo_sync.js"></script>

  <!-- Scripts - Feature Modules -->
  <script src="eo_event_bus.js"></script>
  <script src="eo_views.js"></script>
  <script src="eo_view_hierarchy.js"></script>
  <script src="eo_graph_cytoscape.js"></script>
  <script src="eo_graph.js"></script>
  <script src="eo_provenance.js"></script>
  <script src="eo_import.js"></script>
  <script src="eo_data_workbench.js"></script>

  <!-- Scripts - Transparency -->
  <script src="eo_principles_transparency.js"></script>

  <!-- Scripts - UI Controllers -->
  <script src="eo_app.js"></script>
  <script src="eo_workbench.js"></script>

  <!-- Initialize Application -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize the transparency panel first (so it's ready for connection)
      if (window.initTransparencyPanel) {
        const transparency = window.initTransparencyPanel({
          eventBus: window.getEventBus ? window.getEventBus() : null
        });
        transparency.init('principles-panel');
      }

      // Initialize the main application (this will connect the transparency panel)
      if (window.initApp) {
        await window.initApp();
      }
    });
  </script>
</body>
</html>
