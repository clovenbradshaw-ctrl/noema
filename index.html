<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Noema - Data Workbench</title>

  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- Cytoscape.js Graph Visualization - deferred (only needed for graph view) -->
  <script defer src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
  <!-- Cytoscape Layout Extensions - deferred -->
  <script defer src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script defer src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

  <!-- SheetJS for Excel export - deferred (only needed for export) -->
  <script defer src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Fuse.js for fuzzy search - deferred (has fallback) -->
  <script defer src="https://unpkg.com/fuse.js@7.0.0/dist/fuse.min.js"></script>

  <link rel="stylesheet" href="noema_styles.css">
  <link rel="stylesheet" href="noema_integration_styles.css">

  <!-- Theme initialization - runs before body to prevent flash -->
  <script>
    (function() {
      const savedTheme = localStorage.getItem('noema-theme');
      if (savedTheme === 'light') {
        document.documentElement.classList.add('light-theme');
      } else if (savedTheme === 'dark') {
        document.documentElement.classList.add('dark-theme');
      }
      // If no saved theme, CSS will use system preference as fallback
    })();
  </script>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="app-sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-icon">
            <i class="ph ph-database"></i>
          </div>
          <span class="logo-text">Noema</span>
        </div>
        <button class="sidebar-collapse-btn" id="sidebar-collapse">
          <i class="ph ph-caret-left"></i>
        </button>
      </div>

      <!-- Universal Search with Prefix Support -->
      <div class="sidebar-search">
        <div class="search-input-wrapper">
          <i class="ph ph-magnifying-glass"></i>
          <input type="text" placeholder="Search... (@ # > / ? !)" id="global-search" autocomplete="off">
          <span class="search-prefix-hint" id="search-prefix-hint"></span>
        </div>
        <div class="search-prefix-legend" id="search-prefix-legend">
          <span class="prefix-item" data-prefix="">records</span>
          <span class="prefix-item" data-prefix="@">@fields</span>
          <span class="prefix-item" data-prefix="#">#sets</span>
          <span class="prefix-item" data-prefix="/">/views</span>
          <span class="prefix-item" data-prefix="?">?sources</span>
          <span class="prefix-item" data-prefix=">">&gt;commands</span>
        </div>
      </div>

      <!-- Consolidated New Action Button -->
      <div class="sidebar-new-action" id="sidebar-new-action">
        <button class="new-action-btn" id="btn-new-action" title="Create new... (Ctrl+Shift+N)">
          <i class="ph ph-plus-circle"></i>
          <span>New</span>
          <i class="ph ph-caret-down new-action-caret"></i>
        </button>
        <div class="new-action-dropdown" id="new-action-dropdown" style="display: none;">
          <button class="new-action-item" id="new-action-project" data-action="project">
            <i class="ph ph-folder-simple-dashed"></i>
            <div class="new-action-item-content">
              <span class="new-action-item-label">New Project</span>
              <span class="new-action-item-hint">Organize sources, sets & definitions</span>
            </div>
            <span class="new-action-shortcut">Ctrl+Shift+P</span>
          </button>
          <button class="new-action-item" id="new-action-source" data-action="source">
            <i class="ph ph-download-simple"></i>
            <div class="new-action-item-content">
              <span class="new-action-item-label">Import Source</span>
              <span class="new-action-item-hint">Spreadsheets & data files</span>
            </div>
            <span class="new-action-shortcut">Ctrl+I</span>
          </button>
          <button class="new-action-item" id="new-action-definition" data-action="definition">
            <i class="ph ph-book-open"></i>
            <div class="new-action-item-content">
              <span class="new-action-item-label">New Definition</span>
              <span class="new-action-item-hint">Vocabulary schemas from URI</span>
            </div>
          </button>
          <button class="new-action-item" id="new-action-set" data-action="set">
            <i class="ph ph-database"></i>
            <div class="new-action-item-content">
              <span class="new-action-item-label">New Set</span>
              <span class="new-action-item-hint">Create a new data collection</span>
            </div>
            <span class="new-action-shortcut">Ctrl+Shift+S</span>
          </button>
          <button class="new-action-item" id="new-action-view" data-action="view">
            <i class="ph ph-eye"></i>
            <div class="new-action-item-content">
              <span class="new-action-item-label">New View</span>
              <span class="new-action-item-hint">Table, Cards, Kanban, Calendar, Graph</span>
            </div>
            <span class="new-action-shortcut">Ctrl+Shift+V</span>
          </button>
          <div class="new-action-divider"></div>
          <button class="new-action-item" id="new-action-record" data-action="record">
            <i class="ph ph-rows"></i>
            <div class="new-action-item-content">
              <span class="new-action-item-label">New Record</span>
              <span class="new-action-item-hint">Add a record to current set</span>
            </div>
            <span class="new-action-shortcut">Ctrl+N</span>
          </button>
          <button class="new-action-item" id="new-action-field" data-action="field">
            <i class="ph ph-columns-plus-right"></i>
            <div class="new-action-item-content">
              <span class="new-action-item-label">New Field</span>
              <span class="new-action-item-hint">Add a column to current set</span>
            </div>
            <span class="new-action-shortcut">Ctrl+Shift+F</span>
          </button>
          <div class="new-action-divider"></div>
          <button class="new-action-item" id="new-action-export" data-action="export">
            <i class="ph ph-export"></i>
            <div class="new-action-item-content">
              <span class="new-action-item-label">New Export</span>
              <span class="new-action-item-hint">Create immutable snapshot</span>
            </div>
          </button>
        </div>
      </div>

      <!-- Project-Centric Navigation: All content nested under each Project -->
      <!-- Structure: Project → Sources (GIVEN) / Sets (SCHEMA) / Definitions (MEANT) / Exports (GIVEN) -->
      <nav class="sidebar-nav" id="sidebar-nav">
        <!-- Unified Project Panel with nested content -->
        <div class="nav-panel projects-panel" data-panel="projects">
          <div class="nav-panel-header">
            <div class="nav-panel-title">
              <i class="ph ph-folder-simple-dashed"></i>
              <span>Projects</span>
              <span class="nav-panel-badge project-badge">ORG</span>
            </div>
            <div class="nav-panel-actions">
              <button class="nav-panel-action" id="btn-new-project" title="Create new project">
                <i class="ph ph-plus"></i>
              </button>
            </div>
          </div>
          <div class="nav-panel-content" id="projects-nav">
            <!-- Projects with nested Sources/Sets/Definitions/Exports rendered dynamically -->
          </div>
        </div>
      </nav>

      <!-- Sidebar Footer -->
      <div class="sidebar-footer" data-collapsible="true">
        <div class="sidebar-footer-header" id="sidebar-footer-toggle" title="Click to expand/collapse">
          <span class="sidebar-footer-title">
            <i class="ph ph-caret-down sidebar-footer-caret"></i>
            <span>Menu</span>
          </span>
        </div>
        <div class="sidebar-footer-content">
          <div class="nav-item" id="nav-tossed-items" title="View tossed items (deletion history)">
            <i class="ph ph-trash"></i>
            <span>Tossed</span>
            <span class="tossed-badge" id="tossed-count-badge" style="display: none;">0</span>
          </div>
          <div class="nav-item" id="nav-activity-stream" title="View activity stream">
            <i class="ph ph-list-bullets"></i>
            <span>Activity</span>
          </div>
          <div class="nav-item" id="nav-keyboard-shortcuts" title="Keyboard Shortcuts (?)">
            <i class="ph ph-keyboard"></i>
            <span>Shortcuts</span>
          </div>
          <div class="nav-item" id="nav-theme-toggle" title="Toggle dark/light mode">
            <i class="ph ph-moon" id="theme-icon"></i>
            <span id="theme-label">Dark Mode</span>
          </div>
          <div class="nav-item" id="nav-settings">
            <i class="ph ph-gear"></i>
            <span>Settings</span>
          </div>
          <div class="nav-item" id="nav-sync">
            <i class="ph ph-cloud-check"></i>
            <span>Sync Status</span>
            <span class="sync-badge synced" id="sync-status-badge">
              <i class="ph ph-check-circle"></i>
            </span>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Simplified Top Toolbar -->
      <header class="header header-simplified">
        <div class="header-left">
          <button class="header-btn mobile-menu" id="mobile-menu-btn">
            <i class="ph ph-list"></i>
          </button>
          <!-- Data Flow Breadcrumb: Source → Set → Lens → View -->
          <div class="breadcrumb data-flow-breadcrumb">
            <!-- Project (Organization) -->
            <span class="breadcrumb-item breadcrumb-project" id="current-project-name" title="Project">
              <i class="ph ph-folder-simple-dashed"></i>
              All Items
            </span>
            <i class="ph ph-caret-right breadcrumb-separator project-separator"></i>
            <!-- Source (GIVEN) - shown when viewing source or set derived from source -->
            <span class="breadcrumb-item breadcrumb-source" id="current-source-name" title="Source (GIVEN)" style="display: none;">
              <span class="breadcrumb-epistemic-dot given-dot"></span>
              <i class="ph ph-download-simple"></i>
              <span class="breadcrumb-source-text">Source</span>
            </span>
            <i class="ph ph-caret-right breadcrumb-separator source-separator" style="display: none;"></i>
            <!-- Set (SCHEMA) -->
            <span class="breadcrumb-item breadcrumb-set" id="current-set-name" title="Set (SCHEMA)">
              <span class="breadcrumb-epistemic-dot schema-dot"></span>
              Set
            </span>
            <i class="ph ph-caret-right breadcrumb-separator"></i>
            <!-- Lens/View -->
            <span class="breadcrumb-item breadcrumb-view" id="current-view-name" title="Lens/View">Lens</span>
            <!-- Focus (Rule 5 Restriction) -->
            <span class="breadcrumb-item active focus-breadcrumb" id="current-focus-name" style="display: none;">
              <i class="ph ph-caret-right"></i>
              <i class="ph ph-funnel"></i>
              Focus
            </span>
          </div>
        </div>
        <div class="header-center">
          <!-- Set Tag Selector (compact) -->
          <div class="set-tag-selector" id="set-tag-selector">
            <button class="set-tag-btn" id="set-tag-btn" title="Filter by tag">
              <i class="ph ph-tag"></i>
              <span class="set-tag-label">All Sets</span>
              <i class="ph ph-caret-down"></i>
            </button>
            <div class="set-tag-dropdown" id="set-tag-dropdown" style="display: none;">
              <!-- Tag options rendered dynamically -->
            </div>
          </div>
        </div>
      </header>

      <!-- Architecture Chain Header (SOURCE → SET → LENS → VIEW) -->
      <div class="architecture-chain" id="architecture-chain">
        <div class="chain-step source" data-step="source" id="chain-step-source">
          <i class="ph ph-download-simple"></i>
          <span class="chain-step-name" id="chain-source-name">No Source</span>
        </div>
        <i class="ph ph-arrow-right chain-arrow"></i>
        <div class="chain-step set" data-step="set" id="chain-step-set">
          <i class="ph ph-database"></i>
          <span class="chain-step-name" id="chain-set-name">No Set</span>
        </div>
        <i class="ph ph-arrow-right chain-arrow"></i>
        <div class="chain-step lens" data-step="lens" id="chain-step-lens">
          <i class="ph ph-funnel"></i>
          <span class="chain-step-name" id="chain-lens-name">All Records</span>
        </div>
        <i class="ph ph-arrow-right chain-arrow"></i>
        <div class="chain-step view active" data-step="view" id="chain-step-view">
          <i class="ph ph-eye"></i>
          <span class="chain-step-name" id="chain-view-name">Grid</span>
        </div>
      </div>

      <!-- Bulk Actions Toolbar (shown when records selected) -->
      <div class="bulk-actions-toolbar" id="bulk-actions-toolbar" style="display: none;">
        <div class="bulk-actions-info">
          <i class="ph ph-check-square"></i>
          <span id="bulk-selected-count">0 selected</span>
        </div>
        <div class="bulk-actions-buttons">
          <button class="bulk-action-btn" id="bulk-duplicate" title="Duplicate selected">
            <i class="ph ph-copy"></i>
            <span>Duplicate</span>
          </button>
          <button class="bulk-action-btn" id="bulk-export" title="Export selected">
            <i class="ph ph-export"></i>
            <span>Export</span>
          </button>
          <button class="bulk-action-btn danger" id="bulk-delete" title="Delete selected">
            <i class="ph ph-trash"></i>
            <span>Delete</span>
          </button>
        </div>
        <button class="bulk-actions-close" id="bulk-actions-close" title="Clear selection">
          <i class="ph ph-x"></i>
        </button>
      </div>

      <!-- Browser-Style Tab Bar -->
      <div class="tab-bar" id="tab-bar">
        <div class="tab-bar-scroll-left" id="tab-scroll-left" style="display: none;">
          <i class="ph ph-caret-left"></i>
        </div>
        <div class="tab-bar-tabs" id="tab-bar-tabs">
          <!-- Tabs rendered dynamically -->
        </div>
        <div class="tab-bar-scroll-right" id="tab-scroll-right" style="display: none;">
          <i class="ph ph-caret-right"></i>
        </div>
        <button class="tab-bar-new-tab" id="new-tab-btn" title="New tab (Ctrl+T)">
          <i class="ph ph-plus"></i>
        </button>
        <div class="tab-bar-actions">
          <button class="tab-bar-action-btn" id="bookmarks-btn" title="Bookmarks">
            <i class="ph ph-bookmark-simple"></i>
          </button>
          <button class="tab-bar-action-btn" id="tab-list-btn" title="View all tabs">
            <i class="ph ph-caret-down"></i>
          </button>
        </div>
      </div>

      <!-- Bookmarks Dropdown -->
      <div class="bookmarks-dropdown" id="bookmarks-dropdown" style="display: none;">
        <div class="bookmarks-dropdown-header">
          <span>Bookmarks</span>
          <button class="bookmarks-new-folder-btn" id="bookmarks-new-folder" title="New folder">
            <i class="ph ph-folder-plus"></i>
          </button>
        </div>
        <div class="bookmarks-dropdown-content">
          <!-- Bookmark items rendered dynamically -->
        </div>
      </div>

      <!-- Tab Toolbar (contextual tools for current tab) -->
      <div class="tab-toolbar" id="tab-toolbar">
        <div class="tab-toolbar-group">
          <button class="tab-toolbar-btn" id="btn-filter-dropdown" title="Focus (Ctrl+F)">
            <i class="ph ph-funnel"></i>
            <span>Focus</span>
          </button>
          <button class="tab-toolbar-btn" id="btn-sort-dropdown" title="Sort records">
            <i class="ph ph-sort-ascending"></i>
            <span>Sort</span>
          </button>
          <button class="tab-toolbar-btn" id="btn-fields-dropdown" title="Show/hide fields">
            <i class="ph ph-columns"></i>
            <span>Fields</span>
          </button>
          <button class="tab-toolbar-btn" id="btn-pipeline-dropdown" title="Pipeline">
            <i class="ph ph-git-merge"></i>
            <span>Pipeline</span>
          </button>
        </div>
        <div class="tab-toolbar-divider"></div>
        <div class="tab-toolbar-group">
          <button class="tab-toolbar-btn" id="btn-import-dropdown" title="Import CSV or JSON">
            <i class="ph ph-download"></i>
            <span>Import</span>
          </button>
          <button class="tab-toolbar-btn" id="btn-export-dropdown" title="Export (Ctrl+S)">
            <i class="ph ph-export"></i>
            <span>Export</span>
          </button>
        </div>
      </div>

      <!-- View Disclosure Panel (shows views for current set) -->
      <div class="view-disclosure" id="view-disclosure" style="display: none;">
        <div class="view-disclosure-header">
          <button class="view-disclosure-toggle" id="view-disclosure-toggle" title="Toggle view disclosure">
            <i class="ph ph-caret-down"></i>
          </button>
          <span class="view-disclosure-title">
            <i class="ph ph-eye"></i>
            <span id="view-disclosure-set-name">Views</span>
          </span>
          <span class="view-disclosure-count" id="view-disclosure-count">0 views</span>
          <button class="view-disclosure-add" id="view-disclosure-add" title="Add new view">
            <i class="ph ph-plus"></i>
          </button>
        </div>
        <div class="view-disclosure-content" id="view-disclosure-content">
          <!-- Views for current set rendered dynamically -->
        </div>
      </div>

      <!-- Content Area -->
      <div class="content-area" id="content-area">
        <!-- Initial loading state - hidden once app initializes -->
        <div class="app-loading-state" id="app-loading-state">
          <div class="app-loading-content">
            <i class="ph ph-database app-loading-icon"></i>
            <div class="app-loading-text">Loading workspace...</div>
            <div class="app-loading-subtext">Restoring your data</div>
          </div>
        </div>
      </div>

      <!-- Status Bar -->
      <footer class="status-bar">
        <div class="status-left">
          <span class="status-item" id="record-count">
            <i class="ph ph-rows"></i>
            <span>0 records</span>
          </span>
          <span class="status-divider"></span>
          <span class="status-item" id="selected-count">
            <i class="ph ph-check-square"></i>
            <span>0 selected</span>
          </span>
        </div>
        <div class="status-center">
          <span class="status-item eo-indicator" id="eo-status">
            <span class="eo-dot given"></span>
            <span class="eo-dot meant"></span>
            <span>EO Compliant</span>
          </span>
        </div>
        <div class="status-right">
          <span class="status-item" id="last-saved">
            <i class="ph ph-clock"></i>
            <span>Just now</span>
          </span>
        </div>
      </footer>
    </main>

    <!-- Record Detail Panel (Right Sidebar) -->
    <aside class="detail-panel" id="detail-panel">
      <div class="detail-panel-header">
        <h3>Record Details</h3>
        <button class="detail-panel-close" id="detail-panel-close">
          <i class="ph ph-x"></i>
        </button>
      </div>
      <div class="detail-panel-body" id="detail-panel-body">
        <div class="empty-state-small">
          <i class="ph ph-cursor-click"></i>
          <p>Select a record to view details</p>
        </div>
      </div>
    </aside>

    <!-- Pipeline Panel (Right Sidebar for pipeline management) -->
    <aside class="pipeline-panel" id="pipeline-panel">
      <div class="pipeline-panel-header">
        <div class="pipeline-header-title">
          <i class="ph ph-flow-arrow"></i>
          <h3>Data Flow</h3>
        </div>
        <div class="pipeline-header-actions">
          <div class="pipeline-view-toggle" id="pipeline-view-toggle">
            <button class="toggle-btn active" data-view="list" title="List View">
              <i class="ph ph-list"></i>
            </button>
            <button class="toggle-btn" data-view="canvas" title="Canvas View">
              <i class="ph ph-flow-arrow"></i>
            </button>
          </div>
          <button class="pipeline-action-btn" id="pipeline-run-btn" title="Run pipeline">
            <i class="ph ph-play"></i>
          </button>
          <button class="pipeline-panel-close" id="pipeline-panel-close">
            <i class="ph ph-x"></i>
          </button>
        </div>
      </div>
      <div class="pipeline-panel-body" id="pipeline-panel-body">
        <div class="empty-state-small">
          <i class="ph ph-git-merge"></i>
          <p>No pipeline steps yet</p>
          <button class="btn btn-sm btn-primary" id="pipeline-add-first-step">
            <i class="ph ph-plus"></i>
            Add Step
          </button>
        </div>
      </div>
      <div class="pipeline-panel-footer">
        <button class="btn btn-sm btn-primary" id="pipeline-add-step-btn">
          <i class="ph ph-plus"></i>
          Add Step
        </button>
        <button class="btn btn-sm" id="pipeline-history-btn" title="View execution history">
          <i class="ph ph-clock-counter-clockwise"></i>
          History
        </button>
      </div>
    </aside>
  </div>

  <!-- Mobile Panel Backdrop -->
  <div class="mobile-panel-backdrop" id="mobile-panel-backdrop"></div>

  <!-- Modal Overlay -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal" id="modal">
      <div class="modal-header">
        <h3 class="modal-title">Modal Title</h3>
        <button class="modal-close" id="modal-close">
          <i class="ph ph-x"></i>
        </button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Modal content -->
      </div>
      <div class="modal-footer" id="modal-footer">
        <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
        <button class="btn btn-primary" id="modal-confirm">Save</button>
      </div>
    </div>
  </div>

  <!-- Key Suggestion Panel Overlay -->
  <div class="key-suggestion-overlay" id="key-suggestion-overlay" style="display: none;">
    <div class="key-suggestion-container" id="key-suggestion-container">
      <!-- Key suggestion panel rendered dynamically -->
    </div>
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="context-menu">
    <!-- Context menu items rendered dynamically -->
  </div>

  <!-- Advanced Filter Panel -->
  <div class="filter-panel" id="filter-panel" style="display: none;">
    <div class="filter-panel-header">
      <h4><i class="ph ph-funnel"></i> Filter Records</h4>
      <button class="filter-panel-close" id="filter-panel-close">
        <i class="ph ph-x"></i>
      </button>
    </div>
    <div class="filter-panel-body">
      <div class="filter-groups" id="filter-groups">
        <!-- Filter rows added dynamically -->
      </div>
      <button class="add-filter-btn" id="add-filter-btn">
        <i class="ph ph-plus"></i>
        <span>Add filter</span>
      </button>
      <div class="filter-logic-toggle">
        <span class="filter-logic-label">Match</span>
        <select class="filter-logic-select" id="filter-logic">
          <option value="and">All filters (AND)</option>
          <option value="or">Any filter (OR)</option>
        </select>
      </div>
    </div>
    <div class="filter-panel-footer">
      <button class="btn btn-secondary" id="filter-clear">Clear All</button>
      <button class="btn btn-primary" id="filter-apply">Apply Filter</button>
    </div>
  </div>

  <!-- Sort Panel -->
  <div class="sort-panel" id="sort-panel" style="display: none;">
    <div class="sort-panel-header">
      <h4><i class="ph ph-sort-ascending"></i> Sort Records</h4>
      <button class="sort-panel-close" id="sort-panel-close">
        <i class="ph ph-x"></i>
      </button>
    </div>
    <div class="sort-panel-body">
      <div class="sort-rules" id="sort-rules">
        <!-- Sort rules added dynamically -->
      </div>
      <button class="add-sort-btn" id="add-sort-btn">
        <i class="ph ph-plus"></i>
        <span>Add sort</span>
      </button>
    </div>
    <div class="sort-panel-footer">
      <button class="btn btn-secondary" id="sort-clear">Clear All</button>
      <button class="btn btn-primary" id="sort-apply">Apply Sort</button>
    </div>
  </div>

  <!-- Schema Panel (Structure & Meaning - renamed from Fields) -->
  <div class="fields-panel" id="fields-panel" style="display: none;">
    <div class="fields-panel-header">
      <h4><i class="ph ph-blueprint"></i> Schema</h4>
      <button class="fields-panel-close" id="fields-panel-close">
        <i class="ph ph-x"></i>
      </button>
    </div>
    <!-- Schema Tabs: Structure (GIVEN) vs Meaning (MEANT) -->
    <div class="schema-tabs" id="schema-tabs">
      <button class="schema-tab structure active" data-tab="structure">
        <i class="ph ph-tree-structure"></i>
        <span>Structure</span>
      </button>
      <button class="schema-tab meaning" data-tab="meaning">
        <i class="ph ph-book-open"></i>
        <span>Meaning</span>
      </button>
    </div>
    <div class="fields-panel-body">
      <!-- Structure Tab: Name, type, source mapping (GIVEN) -->
      <div class="schema-tab-content" id="schema-structure-content">
        <div class="fields-panel-description">
          <i class="ph ph-lock-simple"></i> Structure is GIVEN: Field names, types, and source mappings.
        </div>
        <div class="fields-list" id="fields-list">
          <!-- Field items rendered dynamically -->
        </div>
      </div>
      <!-- Meaning Tab: Definition bindings, URI, explanation (MEANT) -->
      <div class="schema-tab-content hidden" id="schema-meaning-content">
        <div class="fields-panel-description">
          <i class="ph ph-pencil-simple"></i> Meaning is MEANT: Semantic definitions, URIs, and interpretations.
        </div>
        <div class="schema-meaning-list" id="schema-meaning-list">
          <!-- Meaning items rendered dynamically -->
        </div>
      </div>
    </div>
    <div class="fields-panel-footer">
      <button class="btn btn-secondary" id="fields-show-all">Show All</button>
      <button class="btn btn-secondary" id="fields-hide-all">Hide All</button>
      <button class="btn btn-primary" id="fields-apply">Done</button>
    </div>
  </div>

  <!-- Tossed Items Panel (Deletion History) -->
  <div class="tossed-panel" id="tossed-panel" style="display: none;">
    <div class="tossed-panel-header">
      <h4><i class="ph ph-trash"></i> Tossed Items</h4>
      <button class="tossed-panel-close" id="tossed-panel-close">
        <i class="ph ph-x"></i>
      </button>
    </div>
    <div class="tossed-panel-body">
      <div class="tossed-panel-description">
        Items you've removed. Nothing is ever truly deleted - pick them back up anytime.
      </div>
      <div class="tossed-tree" id="tossed-tree">
        <!-- Tossed items rendered dynamically in tree structure -->
      </div>
      <div class="tossed-empty" id="tossed-empty">
        <i class="ph ph-trash-simple"></i>
        <p>No tossed items</p>
        <span>Items you delete will appear here for recovery</span>
      </div>
    </div>
    <div class="tossed-panel-footer">
      <button class="btn btn-secondary" id="tossed-clear-all">Clear All</button>
      <button class="btn btn-primary" id="tossed-panel-done">Done</button>
    </div>
  </div>

  <!-- Activity Stream Panel -->
  <div class="activity-panel" id="activity-panel" style="display: none;">
    <div class="activity-panel-header">
      <h4><i class="ph ph-list-bullets"></i> Activity Stream</h4>
      <button class="activity-panel-close" id="activity-panel-close">
        <i class="ph ph-x"></i>
      </button>
    </div>
    <div class="activity-panel-body">
      <div class="activity-panel-description">
        Complete history of all actions in this workspace. Click on an action to reverse it.
      </div>
      <div class="activity-filters">
        <select id="activity-filter-type" class="activity-filter-select">
          <option value="all">All Types</option>
          <option value="record">Records</option>
          <option value="field">Fields</option>
          <option value="set">Sets</option>
          <option value="view">Views</option>
          <option value="source">Sources</option>
          <option value="lens">Lenses</option>
        </select>
        <select id="activity-filter-action" class="activity-filter-select">
          <option value="all">All Actions</option>
          <option value="create">Created</option>
          <option value="update">Updated</option>
          <option value="delete">Deleted</option>
          <option value="restore">Restored</option>
        </select>
      </div>
      <div class="activity-table-container" id="activity-table-container">
        <table class="activity-table" id="activity-table">
          <thead>
            <tr>
              <th class="activity-col-time">Time</th>
              <th class="activity-col-action">Action</th>
              <th class="activity-col-type">Type</th>
              <th class="activity-col-name">Name</th>
              <th class="activity-col-details">Details</th>
              <th class="activity-col-actions">Undo</th>
            </tr>
          </thead>
          <tbody id="activity-table-body">
            <!-- Activity rows rendered dynamically -->
          </tbody>
        </table>
      </div>
      <div class="activity-empty" id="activity-empty" style="display: none;">
        <i class="ph ph-clock-counter-clockwise"></i>
        <p>No activity recorded</p>
        <span>Actions you perform will appear here</span>
      </div>
    </div>
    <div class="activity-panel-footer">
      <span class="activity-count" id="activity-count">0 activities</span>
      <button class="btn btn-primary" id="activity-panel-done">Done</button>
    </div>
  </div>

  <!-- Sync Panel (Cloud API Configuration) -->
  <div class="sync-panel" id="sync-panel" style="display: none;">
    <div class="sync-panel-header">
      <h4><i class="ph ph-cloud-arrow-up"></i> Cloud Sync</h4>
      <button class="sync-panel-close" id="sync-panel-close">
        <i class="ph ph-x"></i>
      </button>
    </div>
    <div class="sync-panel-body">
      <div class="sync-panel-description">
        Configure cloud sync to backup and restore your data. Events are synced as an append-only log.
      </div>

      <!-- Status Section -->
      <div class="sync-status-section" id="sync-status-section">
        <div class="sync-status-indicator" id="sync-status-indicator">
          <i class="ph ph-cloud-slash"></i>
          <span>Not configured</span>
        </div>
        <div class="sync-status-details" id="sync-status-details">
          <!-- Details rendered dynamically -->
        </div>
      </div>

      <!-- Configuration Section -->
      <div class="sync-config-section">
        <div class="sync-config-field">
          <label for="sync-endpoint">API Endpoint</label>
          <input type="url" id="sync-endpoint" placeholder="https://api.example.com" autocomplete="off">
          <span class="sync-config-hint">The base URL of your sync API</span>
        </div>

        <div class="sync-config-field">
          <label for="sync-auth-token">Auth Token</label>
          <div class="sync-token-input">
            <input type="password" id="sync-auth-token" placeholder="Bearer token or API key" autocomplete="off">
            <button class="sync-token-toggle" id="sync-token-toggle" type="button">
              <i class="ph ph-eye"></i>
            </button>
          </div>
          <span class="sync-config-hint">Authentication token for API requests</span>
        </div>

        <div class="sync-config-field">
          <label for="sync-workspace-id">Workspace ID</label>
          <input type="text" id="sync-workspace-id" placeholder="default" value="default" autocomplete="off">
          <span class="sync-config-hint">Identifier for this workspace on the server</span>
        </div>

        <div class="sync-config-field sync-config-toggle">
          <label class="sync-toggle-label">
            <input type="checkbox" id="sync-enabled">
            <span class="sync-toggle-slider"></span>
            <span>Enable sync</span>
          </label>
        </div>
      </div>

      <!-- Actions Section -->
      <div class="sync-actions-section">
        <button class="btn btn-secondary" id="sync-test-connection">
          <i class="ph ph-plugs"></i>
          Test Connection
        </button>
        <button class="btn btn-primary" id="sync-now" disabled>
          <i class="ph ph-arrows-clockwise"></i>
          Sync Now
        </button>
      </div>

      <!-- Last Sync Info -->
      <div class="sync-last-info" id="sync-last-info" style="display: none;">
        <div class="sync-last-row">
          <span class="sync-last-label">Last sync:</span>
          <span class="sync-last-value" id="sync-last-time">Never</span>
        </div>
        <div class="sync-last-row">
          <span class="sync-last-label">Events pushed:</span>
          <span class="sync-last-value" id="sync-pushed-count">0</span>
        </div>
        <div class="sync-last-row">
          <span class="sync-last-label">Events pulled:</span>
          <span class="sync-last-value" id="sync-pulled-count">0</span>
        </div>
        <div class="sync-last-row">
          <span class="sync-last-label">Local events:</span>
          <span class="sync-last-value" id="sync-local-count">0</span>
        </div>
      </div>

      <!-- Error Display -->
      <div class="sync-error" id="sync-error" style="display: none;">
        <i class="ph ph-warning-circle"></i>
        <span id="sync-error-message"></span>
      </div>
    </div>
    <div class="sync-panel-footer">
      <button class="btn btn-secondary" id="sync-panel-cancel">Cancel</button>
      <button class="btn btn-primary" id="sync-panel-save">Save Configuration</button>
    </div>
  </div>

  <!-- Field Type Picker -->
  <div class="field-type-picker" id="field-type-picker">
    <div class="field-type-list">
      <div class="field-type-item" data-type="text">
        <i class="ph ph-text-aa"></i>
        <span>Single line text</span>
      </div>
      <div class="field-type-item" data-type="longText">
        <i class="ph ph-text-align-left"></i>
        <span>Long text</span>
      </div>
      <div class="field-type-item" data-type="number">
        <i class="ph ph-hash"></i>
        <span>Number</span>
      </div>
      <div class="field-type-item" data-type="select">
        <i class="ph ph-list-bullets"></i>
        <span>Single select</span>
      </div>
      <div class="field-type-item" data-type="multiSelect">
        <i class="ph ph-list-checks"></i>
        <span>Multiple select</span>
      </div>
      <div class="field-type-item" data-type="date">
        <i class="ph ph-calendar"></i>
        <span>Date</span>
      </div>
      <div class="field-type-item" data-type="checkbox">
        <i class="ph ph-check-square"></i>
        <span>Checkbox</span>
      </div>
      <div class="field-type-item" data-type="link">
        <i class="ph ph-link"></i>
        <span>Link to record</span>
      </div>
      <div class="field-type-item" data-type="attachment">
        <i class="ph ph-paperclip"></i>
        <span>Attachment</span>
      </div>
      <div class="field-type-item" data-type="url">
        <i class="ph ph-globe"></i>
        <span>URL</span>
      </div>
      <div class="field-type-item" data-type="email">
        <i class="ph ph-envelope"></i>
        <span>Email</span>
      </div>
      <div class="field-type-item" data-type="phone">
        <i class="ph ph-phone"></i>
        <span>Phone</span>
      </div>
      <div class="field-type-item" data-type="formula">
        <i class="ph ph-function"></i>
        <span>Formula</span>
      </div>
      <div class="field-type-item" data-type="rollup">
        <i class="ph ph-sigma"></i>
        <span>Rollup</span>
      </div>
      <div class="field-type-item" data-type="count">
        <i class="ph ph-number-circle-one"></i>
        <span>Count</span>
      </div>
      <div class="field-type-item" data-type="autonumber">
        <i class="ph ph-number-square-one"></i>
        <span>Autonumber</span>
      </div>
      <div class="field-type-item" data-type="json">
        <i class="ph ph-brackets-curly"></i>
        <span>JSON</span>
      </div>
    </div>
  </div>

  <!-- Keyboard Shortcuts Modal -->
  <div class="shortcuts-modal-overlay" id="shortcuts-modal" style="display: none;">
    <div class="shortcuts-modal">
      <div class="shortcuts-modal-header">
        <h3><i class="ph ph-keyboard"></i> Keyboard Shortcuts</h3>
        <button class="shortcuts-modal-close" id="shortcuts-modal-close">
          <i class="ph ph-x"></i>
        </button>
      </div>
      <div class="shortcuts-modal-body">
        <div class="shortcuts-section">
          <h4>General</h4>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>?</kbd></span>
            <span class="shortcut-desc">Show keyboard shortcuts</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Esc</kbd></span>
            <span class="shortcut-desc">Close modal/panel</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>/</kbd></span>
            <span class="shortcut-desc">Focus search</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>Z</kbd></span>
            <span class="shortcut-desc">Undo</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>Shift</kbd><kbd>Z</kbd></span>
            <span class="shortcut-desc">Redo</span>
          </div>
        </div>
        <div class="shortcuts-section">
          <h4>Create</h4>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>Shift</kbd><kbd>N</kbd></span>
            <span class="shortcut-desc">Open "New" menu</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>I</kbd></span>
            <span class="shortcut-desc">Import source</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>Shift</kbd><kbd>S</kbd></span>
            <span class="shortcut-desc">New set</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>Shift</kbd><kbd>V</kbd></span>
            <span class="shortcut-desc">New view</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>Shift</kbd><kbd>F</kbd></span>
            <span class="shortcut-desc">Add field</span>
          </div>
        </div>
        <div class="shortcuts-section">
          <h4>Records</h4>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>N</kbd></span>
            <span class="shortcut-desc">Add new record</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Delete</kbd></span>
            <span class="shortcut-desc">Delete selected</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>D</kbd></span>
            <span class="shortcut-desc">Duplicate selected</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>A</kbd></span>
            <span class="shortcut-desc">Select all</span>
          </div>
        </div>
        <div class="shortcuts-section">
          <h4>Editing</h4>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Enter</kbd></span>
            <span class="shortcut-desc">Confirm / Open record</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Tab</kbd></span>
            <span class="shortcut-desc">Next cell</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Shift</kbd><kbd>Tab</kbd></span>
            <span class="shortcut-desc">Previous cell</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Double-click</kbd></span>
            <span class="shortcut-desc">Edit cell</span>
          </div>
        </div>
        <div class="shortcuts-section">
          <h4>Views</h4>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>1</kbd><kbd>2</kbd><kbd>3</kbd><kbd>4</kbd><kbd>5</kbd></span>
            <span class="shortcut-desc">Switch view type</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>F</kbd></span>
            <span class="shortcut-desc">Filter panel</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>S</kbd></span>
            <span class="shortcut-desc">Export</span>
          </div>
        </div>
        <div class="shortcuts-section">
          <h4>Tabs</h4>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>T</kbd></span>
            <span class="shortcut-desc">New tab</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>W</kbd></span>
            <span class="shortcut-desc">Toss tab</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>Tab</kbd></span>
            <span class="shortcut-desc">Next tab</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>Shift</kbd><kbd>Tab</kbd></span>
            <span class="shortcut-desc">Previous tab</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>Shift</kbd><kbd>T</kbd></span>
            <span class="shortcut-desc">Pick up tossed tab</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Ctrl</kbd><kbd>1-9</kbd></span>
            <span class="shortcut-desc">Go to tab</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Middle-click</kbd></span>
            <span class="shortcut-desc">Toss tab</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-keys"><kbd>Double-click</kbd></span>
            <span class="shortcut-desc">Rename tab</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Principles Transparency Panel Container -->
  <div id="principles-panel" class="principles-panel"></div>

  <!-- Scripts - Core EO Modules (Strict EO-Aligned) -->
  <script src="noema_types.js"></script>         <!-- Core Types: EpistemicType, GroundingKind, Frame, Supersession -->
  <script src="noema_operators.js"></script>     <!-- EO Operators: Entry, Restrictive, Shape, Compute, etc. -->
  <script src="noema_grounding.js"></script>     <!-- Typed Grounding System: External, Structural, Semantic, Computational -->
  <script src="noema_ontology.js"></script>      <!-- Ontology: Source/Set separation, Schema Split (Structural/Semantic) -->
  <script src="noema_activity.js"></script>      <!-- Activity System: Operator × Target × Context -->
  <script src="noema_event_store.js"></script>   <!-- Event Store: given/meant/derived_value with typed grounding -->
  <script src="noema_derived_values.js"></script> <!-- Derived Values: Aggregations, Confidence as first-class artifacts -->
  <script src="noema_horizon.js"></script>
  <script src="noema_compliance.js"></script>    <!-- Compliance: Strict EO rule enforcement -->
  <script src="noema_ghost_registry.js"></script>  <!-- Ghost Registry: Deleted data that haunts -->
  <script src="noema_state_derivation.js"></script>
  <script src="noema_persistence.js"></script>
  <script src="noema_sync.js"></script>
  <script src="noema_sync_api.js"></script>
  <script src="noema_modal.js"></script>          <!-- Reusable Modal Component System -->
  <script src="noema_sync_wizard.js"></script>    <!-- Step-by-step Sync Configuration Wizard -->
  <script src="noema_pipeline_graph.js"></script>       <!-- Pipeline Graph: Dependency tracking & caching -->
  <script src="noema_formula_semantic.js"></script>     <!-- Semantic Functions: AV-inspired epistemics -->
  <script src="noema_formula_functions.js"></script>    <!-- Function Library with EO Decomposition -->
  <script src="noema_formula_parser.js"></script>       <!-- Enhanced Parser for Custom Syntax -->
  <script src="noema_formula_editor.js"></script>       <!-- Formula Field Creation/Editing Module -->
  <script src="noema_formula_editor_v3.js"></script>    <!-- EO-Native Formula Workbench: Vertical epistemic flow -->
  <script src="noema_sup_formula_functions.js"></script> <!-- SUP Formula Functions: Superposition-aware formulas -->
  <script src="noema_formula_engine.js"></script>       <!-- Formula Engine: Pipeline-based formula evaluation -->
  <script src="noema_formula_explainer.js"></script>    <!-- Formula Explainer: Interactive documentation -->

  <!-- Scripts - Feature Modules -->
  <script src="noema_event_bus.js"></script>
  <script src="noema_view_hierarchy.js"></script>
  <script src="noema_graph_cytoscape.js"></script>
  <script src="noema_graph.js"></script>
  <script src="noema_agent.js"></script>           <!-- Agent Session: Identity & Provenance -->
  <script src="noema_provenance.js"></script>      <!-- Interpretation Parameters: 9-element schema for Sets -->
  <script src="noema_source_provenance.js"></script>  <!-- Source Provenance: Identity/Space/Time for raw data -->

  <!-- Scripts - Interpretation Layer -->
  <script src="noema_schema_semantic.js"></script>     <!-- Schema Semantics: Versioned column meanings -->
  <script src="noema_interpretation_binding.js"></script> <!-- Interpretation Bindings: Column-to-semantic mappings -->
  <script src="noema_semantic_suggestions.js"></script>   <!-- Semantic Suggestions: Wikidata/QUDT integration -->
  <script src="noema_interpretation_panel.js"></script>   <!-- Interpretation Panel UI -->
  <script src="noema_semantic_browser.js"></script>       <!-- Semantic Browser UI -->
  <script src="noema_definition_api.js"></script>         <!-- Definition API: Wikidata, eCFR, LOV, etc. -->
  <script src="noema_definition_source.js"></script>      <!-- Definition Source Schema -->
  <script src="noema_key_definition_lookup.js"></script>  <!-- Key Definition Lookup: API calls for imported keys -->
  <script src="noema_key_suggestion_panel.js"></script>  <!-- Key Suggestion Panel: Auto-import suggestions UI -->
  <script src="noema_definition_builder.js"></script>     <!-- Definition Builder: 9-parameter EO definition construction -->

  <!-- Scripts - Value Vocabulary & Schema-Tracked Export Layer -->
  <script src="noema_value_vocabulary.js"></script>       <!-- Value Vocabularies: Definitions for values not just keys -->
  <script src="noema_schema_tracked_export.js"></script>  <!-- Schema-Tracked Export: Full semantic layer in exports -->
  <script src="noema_export_viewer.js"></script>          <!-- Export Viewer: Navigate schema-tracked exports -->

  <script src="noema_import.js"></script>
  <script src="noema_export.js"></script>
  <script src="noema_query_language.js"></script> <!-- Query Language Parser for SQL/EOQL -->
  <script src="noema_sql_query.js"></script>     <!-- SQL Query Interface with EO-IR Provenance -->
  <script src="noema_storage.js"></script>       <!-- IndexedDB Storage for Large Data -->
  <script src="noema_merge_questions.js"></script>  <!-- 3-Questions Framework for Merge Operations -->
  <script src="noema_merge_engine.js"></script>  <!-- Lazy Merge Computation Engine -->
  <script src="noema_source_join.js"></script>   <!-- Source Storage & No-Code Join Builder -->
  <script src="noema_relational_merge.js"></script>   <!-- Phase-Space Relational Merge UI -->
  <script src="noema_pipeline.js"></script>          <!-- Pipeline Engine for Set Transformations -->
  <script src="noema_pipeline_canvas.js"></script>    <!-- n8n-style Pipeline Canvas UI -->
  <script src="noema_temporal_pipeline.js"></script>  <!-- Temporal Pipeline: Visual Pipeline + Time-Travel -->
  <script src="noema_temporal_pipeline_ui.js"></script> <!-- Temporal Pipeline UI: Canvas, Nodes, Timeline -->

  <!-- EO Integration Layer -->
  <script src="noema_nine_operators.js"></script>       <!-- The 9 Canonical Operators -->
  <script src="noema_language.js"></script>             <!-- EO-Aligned Labels & Tooltips -->
  <script src="noema_explanation_panel.js"></script>    <!-- "Why/How" Explanation UI -->
  <script src="noema_lens_inspector.js"></script>       <!-- Lens Pipeline Visualization -->
  <script src="noema_restriction_messages.js"></script> <!-- EO-Grounded Restriction Messages -->
  <script src="noema_definition_behavior.js"></script>  <!-- Definition-Aware Operations -->
  <script src="noema_definitions_set.js"></script>       <!-- Definitions Set Infrastructure & Linking -->
  <script src="noema_disambiguation_panel.js"></script>  <!-- Disambiguation UI for Keys -->
  <script src="noema_superposition_display.js"></script> <!-- SUP Visual Indicators -->
  <script src="noema_field_display_modes.js"></script>  <!-- Field Display Modes: Multiple views for nested JSON -->
  <script src="noema_integration.js"></script>          <!-- Integration Manager -->

  <script src="noema_data_workbench.js"></script>

  <!-- Scripts - UI Controllers -->
  <script src="noema_app.js"></script>

  <!-- Initialize Application -->
  <script>
    // Theme management functions
    function getCurrentTheme() {
      if (document.documentElement.classList.contains('light-theme')) return 'light';
      if (document.documentElement.classList.contains('dark-theme')) return 'dark';
      // Check system preference
      return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
    }

    function setTheme(theme) {
      document.documentElement.classList.remove('light-theme', 'dark-theme');
      if (theme === 'light') {
        document.documentElement.classList.add('light-theme');
      } else {
        document.documentElement.classList.add('dark-theme');
      }
      localStorage.setItem('noema-theme', theme);
      updateThemeToggleUI(theme);
    }

    function updateThemeToggleUI(theme) {
      const icon = document.getElementById('theme-icon');
      const label = document.getElementById('theme-label');
      if (icon && label) {
        if (theme === 'light') {
          icon.className = 'ph ph-sun';
          label.textContent = 'Light Mode';
        } else {
          icon.className = 'ph ph-moon';
          label.textContent = 'Dark Mode';
        }
      }
    }

    function toggleTheme() {
      const current = getCurrentTheme();
      setTheme(current === 'light' ? 'dark' : 'light');
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize theme toggle button
      const themeToggle = document.getElementById('nav-theme-toggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
        // Update UI to reflect current theme
        updateThemeToggleUI(getCurrentTheme());
      }

      // Initialize the main application
      if (window.initApp) {
        await window.initApp();
      }
    });
  </script>
</body>
</html>
